\documentclass{article}

\usepackage{todonotes}
\usepackage{hyperref}
\usepackage{enumitem}
\usepackage{listings}
\lstset{%
  basicstyle=\ttfamily,
}

\title{Sparkle user guide}
\author{Koen van der Blom}
\date{\today}

\begin{document}

\maketitle

\section{Quick start}

Follow these steps:

\begin{itemize}
  \item[\ref{quick:install}] Install Sparkle
  \item[\ref{quick:config_environment}] Prepare your configuration environment
  \item[\ref{quick:execute_commands}] Execute commands
\end{itemize}

\subsection{Installing Sparkle}
\label{quick:install}

\begin{enumerate}
  \item Copy the Sparkle files to your desired directory
  \item Install Python 3.5 (other 3.x versions may work, but were not tested with the packages included in the \texttt{requirements.txt} file.
  \item Install Swig 3.0 -- With Anaconda: \texttt{conda install swig=3.0}
	\item Navigate into the Sparkle directory
  \item Install \texttt{requirements.txt}: \texttt{pip install -r requirements.txt} -- With Anaconda: \texttt{/home/<username>/<anaconda\_dir>/envs/<env\_name>/bin/pip install -r requirements.txt}
  \item Install \texttt{epstopdf} as described in Section~\ref{package:epstopdf}
\end{enumerate}

\subsection{Configuration}
\label{quick:config_environment}

Configuring an algorithm has the following minimal requirements for the algorithm (for an example of a solver directory see Section~\ref{dir:solvers}):

\begin{itemize}
  \item[\ref{quick:solver_grace}] Make the solver executable work on Grace
  \item[\ref{quick:config_wrapper}] An algorithm wrapper called \texttt{sprakle\_smac\_wrapper.py}
  \item[\ref{quick:pcs_file}] A PCS (parameter configuration space) file
  \item The runsolver binary (e.g. from \texttt{Examples/Resources/Solvers/PbO-CCSAT-Generic/})
\end{itemize}

Further, training and testing instance sets are needed (for an example of a solver directory see Section~\ref{dir:solvers}). For the purpose of testing whether your configuration setup works with Sparkle, it is advised to primarily use instances that are solved (relatively) quickly even with the default parameters.

\subsubsection{Making your algorithm run on Grace}
\label{quick:solver_grace}

\todo[inline]{Add helpful tips when available}
Shell and Python scripts should work as is. If a compiled binary does not work, you may have to compile it on Grace and manually install packages on Grace that are needed by your algorithm.

\subsubsection{Creating a wrapper for your algorithm}
\label{quick:config_wrapper}

A template for the wrapper that connects your algorithm with Sparkle is available at \texttt{Examples/Resources/Solvers/template/sparkle\_smac\_wrapper.py}. Within this template a number of \texttt{TODO}s are indicated where you are likely to need to make changes for your specific algorithm. You can also compare the different example solvers to get an idea for what kind of changes are needed.

\subsubsection{Parameter configuration space (PCS) file}
\label{quick:pcs_file}

The PCS (parameter configuration space) format\footnote{See: \url{http://aclib.net/cssc2014/pcs-format.pdf}} is used to pass the possible parameter ranges of an algorithm to Sparkle in a \texttt{.pcs} file. For an example see e.g. \texttt{Examples/Resources/Solvers/PbO-CCSAT-Generic/PbO-CCSAT-params\_test.pcs}.

In this file you should enter all configurable parameters of your algorithm. Note that parameters such as the random seed used by the algorithm should not be configured and therefore should also not be included in the PCS file.

\subsection{Executing commands}
\label{quick:execute_commands}

Executing commands in Sparkle is as simple as running them in the top directory of Sparkle, for example:

\begin{verbatim}
  Commands/initialise.py
\end{verbatim}

Do note that when running on a cluster additional arguments may be needed, for instance under Slurm the above command would change to:

\begin{verbatim}
  srun -N1 -n1 -p graceTST Commands/initialise.py
\end{verbatim}

In the \texttt{Examples/} directory a number of common command sequences are given. For instance, for configuration with specified training and testing sets see e.g. \texttt{Examples/configure\_solver\_pbo-ccsat.sh} for an example of a sequence of commands to execute. Note that these example scripts should not be executed directly, but one command at a time, to give each command time to complete before starting the next one.

\section{File structure}

\subsection{General}
Before doing anything, the following subdirectories are present in the Sparkle directory:

\begin{verbatim}
Commands/
Components/
Documentation/
Examples/
Settings/
Test_Cases/
\end{verbatim}

Based on various Sparkle commands, the following additional subdirectories may be generated:

\begin{itemize}[noitemsep]
  \item[] \texttt{Configuration\_Reports/}
  \item[] \texttt{Extractors/}
  \item[] \texttt{Feature\_Data/}
  \item[\ref{dir:instances}] \texttt{Instances/}
  \item[] \texttt{LOG/}
  \item[] \texttt{Performance\_Data/}
  \item[] \texttt{Records/}
  \item[] \texttt{Reference\_Lists/}
  \item[\ref{dir:solvers}] \texttt{Solvers/}
  \item[] \texttt{Sparkle\_Portfolio\_Selector/}
  \item[] \texttt{TMP/}
\end{itemize}

\subsection{A typical instance directory}
\label{dir:instances}

An instance directory should look something like this:

\begin{verbatim}
Instances/
  Example_Instance_Set/
    instance_a.cnf
    instance_b.cnf
    ...        ...
    instance_z.cnf
\end{verbatim}

This directory simply contains a collection of instances, as example here SAT instances in the CNF format are given.

\subsection{A typical solver directory}
\label{dir:solvers}

A solver directory should look something like this:

\begin{verbatim}
Solver/
  Example_Solver/
    solver
    sparkle_smac_wrapper.py
    parameters.pcs
    runsolver
\end{verbatim}

Here \texttt{solver} is a binary executable of the solver that is to be configured. The \texttt{sprakle\_smac\_wrapper.py} is a wrapper that Sparkle should call to run the solver with specific settings, and then returns a result for the configurator. In \texttt{parameters.pcs} the configurable parameters are described in the PCS format. Finally, \texttt{runsolver} is a binary executable of the runsolver tool. This allows Sparkle to make fair time measurements for all configuration experiments.

\textbf{Note}: Currently the runsolver binary has to be in every solver directory, it can be found in the \texttt{Examples/Resources/Solvers/PbO-CCSAT-Generic/} directory. 

\section{Selection}

\subsection{Requirements}

\subsubsection{Solver directory}
An example solver directory, in this case for the SAT solver CSCCSat.
\begin{verbatim}
Solver/
  CSCCSat/
    CSCCSat
    sparkle_run_default_wrapper.py
\end{verbatim}

\subsubsection{\texttt{sparkle\_run\_default\_wrapper.py}}
The \texttt{sparkle\_run\_default\_wrapper.py} has two functions that need to be implemented for each algorithm:

\begin{itemize}[noitemsep]
  \item \texttt{print\_command(instance\_file, seed\_str: str, cutoff\_time\_str: str)}
  \item \texttt{print\_output(terminal\_output\_file)}
\end{itemize}

\texttt{print\_command(...)} should print a command line call that Sparkle can use to run the algorithm on a given instance file. Ideally, for reproducibility purposes, the seed provided by Sparkle should also be passed to the algorithm. If the algorithm requires this, the cutoff time can also be passed to the algorithm. However, in this case the cutoff time should be made very large. For instance by multiplying by ten with: \texttt{cutoff\_time\_str = str(int(cutoff\_time\_str) * 10)}. This is necessary to ensure Sparkle stops the algorithm after the cutoff time, rather than the algorithm itself. By doing this it is ensured runtime measurements are always done by Sparkle, and thus consistent between algorithms that might measure time differently.

\texttt{print\_output(...)} should process the algorithm output. If the performance measure is \texttt{RUNTIME}, this function only needs to output the algorithm status. For all \texttt{QUALITY} performance measures both the algorithm status and the solution quality have to be given. Run time is measured by Sparkle internally, but can be overwritten by the user if desired. They should be printed in formatted as in the example below:
\begin{verbatim}
quality = 8734
status = SUCCESS
\end{verbatim}

\subsection{Run solvers}
The \texttt{run\_solvers} command runs each solver on every instance (set) currently in the Sparkle platform for which there are no performance values yet.

\section{Commands}
\todo[inline]{Add missing subsections with details of other commands}

Currently the following commands are available in Sparkle (listed alphabetically):

\begin{itemize}[noitemsep]
  \item[] \texttt{add\_feature\_extractor.py}
  \item[] \texttt{add\_instances.py}
  \item[\ref{cmd:add_solver}] \texttt{add\_solver.py}
  \item[] \texttt{cleanup\_current\_sparkle\_platform.py}
  \item[] \texttt{cleanup\_temporary\_files.py}
  \item[] \texttt{compute\_features\_parallel.py}
  \item[] \texttt{compute\_features.py}
  \item[] \texttt{compute\_marginal\_contribution.py}
  \item[\ref{cmd:configure_solver}] \texttt{configure\_solver.py}
  \item[] \texttt{construct\_sparkle\_portfolio\_selector.py}
  \item[\ref{cmd:generate_report_for_configuration}] \texttt{generate\_report\_for\_configuration.py}
  \item[] \texttt{generate\_report\_for\_test.py}
  \item[] \texttt{generate\_report.py}
  \item[\ref{cmd:initialise}] \texttt{initialise.py}
  \item[] \texttt{load\_record.py}
  \item[] \texttt{remove\_feature\_extractor.py}
  \item[] \texttt{remove\_instances.py}
  \item[] \texttt{remove\_record.py}
  \item[] \texttt{remove\_solver.py}
  \item[] \texttt{run\_ablation.py}
  \item[] \texttt{run\_solvers\_parallel.py}
  \item[] \texttt{run\_solvers.py}
  \item[] \texttt{run\_sparkle\_portfolio\_selector.py}
  \item[] \texttt{run\_status.py}
  \item[] \texttt{save\_record.py}
  \item[] \texttt{system\_status.py}
  \item[\ref{cmd:validate_configured_vs_default}] \texttt{validate\_configured\_vs\_default.py}
\end{itemize}

Arguments in [square brackets] are optional, arguments without brackets are mandatory. Input in \textless chevrons\textgreater~indicate required text input, \{curly brackets\} indicate a set of inputs to choose from.

\subsection{\texttt{add\_solver.py}}
\label{cmd:add_solver}
Add a solver to the Sparkle platform.

Arguments:
\begin{itemize}[noitemsep]
  \item[] \texttt{[--run-solver-later]}
  \item[] \texttt{[--nickname <nickname>]}
  \item[] \texttt{[--parallel]}
  \item[] \texttt{--deterministic \{0, 1\}}
  \item[] \texttt{<solver\_source\_directory>}
\end{itemize}

\subsection{\texttt{configure\_solver.py}}
\label{cmd:configure_solver}
Configure a solver in the Sparkle platform.

Arguments:
\begin{itemize}[noitemsep]
  \item[] \texttt{--solver <solver>}
  \item[] \texttt{--instance-set-train <instance-set-train>}
  \item[] \texttt{[--instance-set-test <instance-set-test>]}
  \item[] \texttt{--validate}
  \item[] \texttt{--ablation}
\end{itemize}

Note that the test instance set is only used if the \texttt{--ablation} or \texttt{--validation} flags are given.

\subsection{\texttt{generate\_report\_for\_configuration.py}}
\label{cmd:generate_report_for_configuration}
Generate a report describing the configuration results for a solver and specific instance sets in the Sparkle platform.

Arguments:
\begin{itemize}[noitemsep]
  \item[] \texttt{--solver <solver>}
  \item[] \texttt{[--instance-set-train <instance-set-train>]}
  \item[] \texttt{[--instance-set-test <instance-set-test>]}
\end{itemize}

Note that if a test instance set is given, the training instance set must also be given. When only a solver is given, Sparkle generates a report for the most recent configuration experiment with that solver.

\subsection{\texttt{initialise.py}}
\label{cmd:initialise}

Initialise the Sparkle platform, this command does not have any arguments.

\subsection{\texttt{run\_ablation.py}}
\label{cmd:run_ablation}
Runs parameter importance between the default and configured parameters with ablation. This command requires a finished configuration for the solver instance pair.

Arguments:
\begin{itemize}[noitemsep]
  \item[] \texttt{--solver <solver>}
  \item[] \texttt{[--instance-set-train <instance-set-train>]}
  \item[] \texttt{[--instance-set-test <instance-set-test>]}
\end{itemize}

Note that if no test instance set is given, the validation is performed on the training set.


\subsection{\texttt{validate\_configured\_vs\_default.py}}
\label{cmd:validate_configured_vs_default}
Test the performance of the configured solver and the default solver by doing validation experiments on the training and test sets.

Arguments:
\begin{itemize}[noitemsep]
  \item[] \texttt{--solver <solver>}
  \item[] \texttt{--instance-set-train <instance-set-train>}
  \item[] \texttt{[--instance-set-test <instance-set-test>]}
\end{itemize}

\section{Settings}

\subsection{Sparkle settings}
Most settings can be controlled through \texttt{Settings/sparkle\_settings.ini}. Possible settings are summarised per category in Sect.~\ref{sect:settings_details}. For any settings that are not provided the defaults will be used. Meaning, in the extreme case, that if the settings file is empty (and nothing is set through the command line) everything will run with default values.

For convenience after every command \texttt{Settings/latest.ini} is written with the used settings. This can, for instance, be used to provide the same settings to the next command in a chain. E.g. for \texttt{validate\_configured\_vs\_default} after \texttt{configure\_solver}. The used settings are also recorded in the relevant \texttt{Output/} subdirectory. Note that when writing settings Sparkle always uses the name, and not an alias.

\subsubsection{Example \texttt{sparkle\_settings.ini}}
This is a short example to show the format, see the settings file in \texttt{Settings/sparkle\_settings.ini} for more.

\begin{verbatim}
  [general]
  performance_measure = RUNTIME
  target_cutoff_time = 60

  [configuration]
  number_of_runs = 25

  [slurm]
  number_of_runs_in_parallel = 25
\end{verbatim}

\subsubsection{Names and possible values}
\label{sect:settings_details}
\begin{itemize}[noitemsep]
  \item[] \textbf{[general]}\\
  \item[] \texttt{performance\_measure}

          aliases: \texttt{smac\_run\_obj}

          values: \texttt{\{RUNTIME, QUALITY\_ABSOLUTE} (also: \texttt{QUALITY\}})\texttt{\}}\\
  \item[] \texttt{target\_cutoff\_time}

          aliases: \texttt{smac\_each\_run\_cutoff\_time, cutoff\_time\_each\_performance\_computation}

          values: integer\\
  \item[] \texttt{extractor\_cutoff\_time}

          aliases: \texttt{cutoff\_time\_each\_feature\_computation}

          values: integer\\
  \item[] \texttt{penalty\_multiplier}

          aliases: \texttt{penalty\_number}

          values: integer\\
  \item[] \texttt{solution\_verifier}

          aliases: N/A

          values: \texttt{\{NONE, SAT\}}

          note: Only available for SAT solving.\\
  \item[] \textbf{[configuration]}\\
  \item[] \texttt{budget\_per\_run}

          aliases: \texttt{smac\_whole\_time\_budget}

          values: integer\\
  \item[] \texttt{number\_of\_runs}

          aliases: \texttt{num\_of\_smac\_runs}

          values: integer\\
  \item[] \textbf{[smac]}
  \item[] \texttt{target\_cutoff\_length}

          aliases: \texttt{smac\_each\_run\_cutoff\_length}

          values: \texttt{\{max\}} (other values: whatever is allowed by SMAC)\\
  \item[] \textbf{[ablation]}\\
  \item[] \texttt{racing}

          aliases: \texttt{ablation\_racing}

          values: boolean\\
  \item[] \textbf{[slurm]}\\
  \item[] \texttt{number\_of\_runs\_in\_parallel}

          aliases: \texttt{smac\_run\_obj}

          values: integer\\
  \item[] \texttt{clis\_per\_node}

          aliases: N/A

          values: integer

          note: Not really a Slurm option, will likely be moved to another section.\\
\end{itemize}


\subsection{Priorities}
Settings provided through different channels have different priorities as follows:

\begin{itemize}[noitemsep]
  \item[low] Default -- Default values will be overwritten if a value is given through any other mechanism;
  \item[medium] File -- Settings form the \texttt{Settings/sparkle\_settings.ini} overwrite default values, but are overwritten by settings given through the command line; 
  \item[high-1] Command line file -- Settings files provided through the command line, overwrite default values and other settings files.
  \item[high-2] Command line -- Settings given through the command line overwrite all other settings, including settings files provided through the command line.

\end{itemize}

\subsection{Slurm (focused on Grace)}
Slurm settings can be specified in the \texttt{Settings/sparkle\_slurm\_settings.txt} file. Currently these settings are inserted as is in any \texttt{srun} or \texttt{sbatch} calls done by Sparkle. This means that any options exclusive to one or the other currently should not be used (see Section~\ref{slurm:disallowed}).

\subsubsection{Tested options}
Below a list of tested Slurm options for \texttt{srun} and \texttt{sbatch} is included. Most other options for these commands should also be safe to use (given they are valid), but have not been explicitly tested. Note that any options related to commands other than \texttt{srun} and \texttt{sbatch} should not be used with Sparkle, and should not be included in \texttt{Settings/sparkle\_slurm\_settings.txt}.

\begin{itemize}[noitemsep]
  \item[] \texttt{--partition / -p}
  \item[] \texttt{--exclude}
  \item[] \texttt{--nodelist}
\end{itemize}

\subsubsection{Disallowed options}
\label{slurm:disallowed}
The options below are exclusive to \texttt{sbatch} and are thus disallowed:

\begin{itemize}[noitemsep]
  \item[] \texttt{--array}
  \item[] \texttt{--clusters}
  \item[] \texttt{--wrap}
\end{itemize}

The options below are exclusive to \texttt{srun} and are thus disallowed:

\begin{itemize}[noitemsep]
  \item[] \texttt{--label}
\end{itemize}

\subsubsection{Nested \texttt{srun} calls}
A number of Sparkle commands internally call the \texttt{srun} command, and for those commands the provided settings need to match the restrictions of your call to a Sparkle command. Take for instance the following command:

\begin{lstlisting}[breaklines]
srun -N1 -n1 -p graceTST Commands/configure_solver.py --solver Solvers/Yahsp3 --instances-train Instances/Depots_train_few/
\end{lstlisting}

This call restricts itself to the \texttt{graceTST} partition (the \texttt{graceTST} partition only consists of node 22). So if the settings file contains the setting \texttt{--exclude=ethnode22}, all available nodes are excluded, and the command cannot execute any internal \texttt{srun} commands it may have.

Finally, Slurm ignores nested partition settings for \texttt{srun}, but not for \texttt{sbatch}. This means that if you specify the \texttt{graceTST} partition (as above) in your command, but the \texttt{graceADA} partition in the settings file, Slurm will still execute any nested \texttt{srun} commands on the \texttt{graceTST} partition only.

\section{Required packages}

\subsection{Sparkle on Grace}

Grace is the computing cluster of the ADA group\footnote{\url{http://ada.liacs.nl/}} at LIACS, Leiden University. Since not all packages required by Sparkle are installed on the system, some have to be installed local to the user.

\subsubsection{\texttt{epstopdf}}
\label{package:epstopdf}

The \texttt{epstopdf} package (or a package containing it) is required for Sparkle's reporting component to work (e.g. \texttt{generate\_report, generate\_report\_for\_configuration}), it can be installed in your user directory as follows:

\begin{enumerate}
  \item Download \texttt{epstopdf}

  \texttt{wget http://mirrors.ctan.org/support/epstopdf.zip}

  \item Unzip the package (ideally somewhere static, rather than a \texttt{/Downloads/} directory)

  \texttt{unzip epstopdf.zip}

  \item Rename \texttt{epstopdf.pl} (inside the directory you just unzipped)

  \texttt{mv epstopdf.pl epstopdf}

  \item Add this line to your \texttt{.bashrc} (open with e.g. \texttt{vim \~{}/.bashrc})

  \texttt{export PATH="/<directory>/epstopdf:\$PATH"}

  (replace "\texttt{<directory>}" with the path to the \texttt{epstopdf} directory, e.g.: \texttt{home/blomkvander/bin})

  \item Reload \texttt{.bashrc} to make sure everything is updated

  \texttt{source \textasciitilde/.bashrc}
\end{enumerate}

\subsubsection{General requirements (to be revised)}
\todo[inline]{Check which of these old installation instructions actually apply (if any)}

Currently Sparkle uses Python 2.7.

\begin{verbatim}
  # Before starting Sparkle, please install the following packages with the specific versions:
  # pip3 install ConfigSpace==0.3.9 --user
  # pip3 install smac==0.6.0 --user
  # pip3 install install git+https://github.com/mlindauer/ASlibScenario --user
  # pip3 install sphinx-bootstrap-theme==0.6.0 --user
  
  # Also, please install the following software:
  # pdflatex, latex, bibtex, swig, gnuplot, gnuplot-x11
\end{verbatim}

\subsection{Yahsp example}

\todo[inline]{Describe how to make the Yahsp example work}

\end{document}
