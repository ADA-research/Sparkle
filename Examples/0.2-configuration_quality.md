# Use Sparkle for algorithm configution

## Initialise the Sparkle platform

```
Usage: sparkle-init <path>
```

```bash
sparkle init algoconf-example
cd algoconf-example
```

## Add compute units

The command `compute` allow to management of the computing unit (where the calculation will be executed). 

The list the available compute unit
```bash
sparkle compute list
```
By default, the `local` compute unit is always available. 

To add a compute unit named `slurm` use
```bash
sparkle compute add slurm --conf=..Examples/slurm-grace.conf
```

*TODO: The options and format of `.conf` files.*


## Add instances

```
Usage: sparkle-instance list 
Usage: sparkle-instance add [-n INSTANCE -lv] <instances paths> 
Usage: sparkle-instance show INSTANCE 
Usage: sparkle-instance rm [-v] INSTANCE 

-h, --help                      Show help 
-l, --link                      Create symbolic links instead of copying files.
-n INSTANCE, --name INSTANCE    Instance name. For `add` default to: set1, set2, ...
-v, --verbose                   Verbose output 
```


Add train instances (in this case for the VRP) in a given directory.
```bash
sparkle-instance add --name X-1-10 ../Examples/Resources/CVRP/Instances/X-1-10
sparkle-instance add -n setB ../Examples/Resources/CVRP/Instances/X-11-20
sparkle-instance add ../Examples/Resources/CVRP/Instances/*
```


## Add a configurable solver

Add a configurable solver (here for vehicle routing) with a wrapper containing the executable name of the solver and a string of command line parameters, without running the solver yet

The solver directory should contain the solver executable, the `sparkle_smac_wrapper.py` wrapper, and a `.pcs` file describing the configurable parameters

```
Usage: sparkle-solver list 
Usage: sparkle-solver add [-n SOLVER -vld] <solver path> 
Usage: sparkle-solver show SOLVER 
Usage: sparkle-solver rm [-v] SOLVER 
Usage: sparkle-solver run [-vCAVa -r RUNS -b BUDGET -c CUTOFF -i INSTANCE -t TEST] --metric METRIC [SOLVER] 

SOLVER                            Name of the solver(s) to configure. If not set use (last or all?)
-A, --all                         Run on all solver? 
-L --last                         Run on last added solver? 
-n SOLVER, --name SOLVER          Solver name. Default: solver1, solver2, ...
-i INSTANCE, --instance INSTANCE  The instance set on which to train. 
-t TEST, --test TEST              The instance set on which to test. 
-m  METRIC, --metric METRIC       The metric to use. METRIC = runtime | quality
-d, --deterministic               Set the solver as deterministic.
-r RUNS, --runs RUNS              Number of solver run.
-b BUDGET, --budget BUDGET        Budget per run.
-c CUTOFF, --cutoff CUTOFF        Target cutoff time.
-l, --link                        Create symbolic links. Do not copy files.
-C, --configure                   Configure the solver using INSTANCE (Need test set ?).
-V, --validate                    Validate after configuration (Need test set ?).
-A, --ablation                    Run ablation after configuration. (Should -V and -a should have their own commands).

-v, --verbose                     Verbose output 
-h, --help                        Show help 
```

```bash
sparkle-solver add -n VRP ../Examples/Resources/Solvers/CVRP/VRP_SISRs
```


## Configure the solver

Perform configuration on the solver to obtain a target configuration. For the VRP we measure the absolute quality performance by setting the `--performance-measure` option, to avoid needing this for every command it can also be set in `Settings/sparkle_settings.ini`.

To run
```bash
sparkle solver run --configure VRP --train iset1 --metric quality
```
This command will return immediatly and the configuration will be run on the slurm cluster. To query the status of Sparkle and of the running job:
```bash
sparkle status 
```

To wait for the completion of the jobs
```bash
sparkle wait
```

## Validate the configuration

To make sure configuration is completed before running validation you can use the sparkle_wait command

Validate the performance of the best found parameter configuration. The test set is optional. We again set the performance measure to absolute quality.

```bash
sparkle solver --validate VRP --train=iset1 --test=iset2 --metric=quality --runon=slurm --wait
```

## Generate a report


Generate a report detailing the results on the training (and optionally testing) set. This includes the experimental procedure and performance information; this will be located in a `Configuration_Reports/` subdirectory for the solver, training set, and optionally test set like `VRP_SISRs_X-1-10/Sparkle-latex-generator-for-configuration/`. We again set the performance measure to absolute quality.

```bash
sparkle report --metric=quality --solver=VRP --train=iset1 --test=iset2
```
