# Use Sparkle for algorithm configution

The base stucture of most commands are
```bash
sparkle <command> <action> ... [--runon=<compute unit>] [--wait]
```

The `--run-on=<compute unit>` allow to choose where to run the command. By default, the command is run the `local` machine. 

The `--wait` flag will make the Sparkle wait for the comman to complete before returning to the shell. It is imply when using `--runon=local` (the default value of `--runon`). 

## Initialise the Sparkle platform

```bash
sparkle init algoconf-example
cd algoconf-example
```

## Add compute units

The command `compute` allow to management of the computing unit (where the calculation will be executed). 

The list the available compute unit
```bash
sparkle compute list
```
By default, the `local` compute unit is always available. 

To add a compute unit named `slurm` use
```bash
sparkle compute add slurm --conf=grace.conf
```

*TODO: The options and format of `.conf` files.*


## Add instances

Add train instances (in this case for the VRP) in a given directory.

```bash
sparkle instance add iset1 Examples/Resources/CVRP/Instances/X-1-10
sparkle instance add iset2 Examples/Resources/CVRP/Instances/X-11-20
sparkle instance add ifull Examples/Resources/CVRP/Instances/*
```


## Add a configurable solver

Add a configurable solver (here for vehicle routing) with a wrapper containing the executable name of the solver and a string of command line parameters, without running the solver yet

The solver directory should contain the solver executable, the `sparkle_smac_wrapper.py` wrapper, and a `.pcs` file describing the configurable parameters

```bash
sparkle solver add VRP Examples/Resources/Solvers/CVRP/VRP_SISRs
```


## Configure the solver

Perform configuration on the solver to obtain a target configuration. For the VRP we measure the absolute quality performance by setting the `--performance-measure` option, to avoid needing this for every command it can also be set in `Settings/sparkle_settings.ini`.

To run on `slurm`
```bash
sparkle solver configure VRP --train=iset1 --metric=quality --runon=slurm
```
This command will return immediatly and the configuration will be run on the slurm cluster. To query the status of Sparkle and of the running job:
```bash
sparkle status 
```

To wait for the completion of the jobs
```
sparkle wait
```

To run on the local machine
```
sparkle solver configure VRP --train=iset1 --metric=quality
```
this command is equivalent to
```
sparkle solver configure VRP --train=iset1 --metric=quality --runon=local --wait
```

## Validate the configuration

To make sure configuration is completed before running validation you can use the sparkle_wait command

Validate the performance of the best found parameter configuration. The test set is optional. We again set the performance measure to absolute quality.

```bash
sparkle solver validate VRP --train=iset1 --test=iset2 --metric=quality --runon=slurm --wait
```

## Generate a report


Generate a report detailing the results on the training (and optionally testing) set. This includes the experimental procedure and performance information; this will be located in a `Configuration_Reports/` subdirectory for the solver, training set, and optionally test set like `VRP_SISRs_X-1-10/Sparkle-latex-generator-for-configuration/`. We again set the performance measure to absolute quality.

```bash
sparkle report --metric=quality --solver=VRP --train=iset1 --test=iset2
```




